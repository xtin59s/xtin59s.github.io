(()=>{var I=window;function L(e){return new t(e)}function d(e,t){function n(){i=v.isWebM=!1,T(v),s=v.isWorklet=!M||L[R];var t,n,r,o,a=I.AudioWorkletNode;s&&h[_]&&a?(t=function(){function e(e){return e.toString().replace(/^function|DEL_/g,"").replace(/\$RA/g,y)}var t="class "+b+" extends AudioWorkletProcessor{",t=(t=(t+="constructor "+e(function(e){DEL_super(e);var t=this,n=e.processorOptions.bufferSize;t.bufferSize=n,t.buffer=new Float32Array(2*n),t.pos=0,t.port.onmessage=function(e){e.data.kill&&(t.kill=!0,console.log("$RA kill call"))},console.log("$RA .ctor call",e)}))+("process "+e(function(e,t,n){var r=this,o=r.bufferSize,a=r.buffer,i=r.pos;return(e=(e[0]||[])[0]||[]).length&&(a.set(e,i),(e=~~((i+=e.length)/o)*o)&&(this.port.postMessage({val:a.slice(0,e)}),e=a.subarray(e,i),(a=new Float32Array(2*o)).set(e),i=e.length,r.buffer=a),r.pos=i),!r.kill})))+('}try{registerProcessor("'+b+'", '+b+')}catch(e){console.error("'+y+'注册失败",e)}');return"data:text/javascript;base64,"+btoa(unescape(encodeURIComponent(t)))},n=function(){return s&&v._na},r=v._na=function(){""!==c&&(clearTimeout(c),c=setTimeout(function(){c=0,n()&&(U(_+"未返回任何音频，恢复使用"+S,3),M)&&w()},500))},o=function(){var e;n()&&(e=v._n=new a(h,b,{processorOptions:{bufferSize:p}}),g(e),e.port.onmessage=function(e){c&&(clearTimeout(c),c=""),n()?C(e.data.val):s||U(_+"多余回调",3)},U("Connect采用"+_+"，设置"+D+"."+R+"=false可恢复老式"+S+m+x,3))},h.resume()[d&&"finally"](function(){var e;n()&&(h[b]?o():(e=t(),h[_].addModule(e).then(function(e){n()&&(h[b]=1,o(),c)&&r()})[O](function(e){U(_+".addModule失败",1,e),n()&&w()})))})):w()}var i,s,c,r,o,a,f,u,l,p=e.BufferSize||L.BufferSize,h=L.Ctx,v=e.Stream,g=function(e){var t=v._m=h.createMediaStreamSource(v),n=h.destination,r="createMediaStreamDestination";h[r]&&(n=h[r]()),t.connect(e),e.connect(n)},m="",d=v._call,C=function(e){for(var t in d){for(var n,r=e.length,o=new Int16Array(r),a=0,i=0;i<r;i++){var s=Math.max(-1,Math.min(1,e[i]));o[i]=s=s<0?32768*s:32767*s,a+=Math.abs(s)}for(n in d)d[n](o,a);return}},S="ScriptProcessor",_="audioWorklet",y=D+" "+_,b="RecProc",k="MediaRecorder",e=k+".WebM.PCM",M=h.createScriptProcessor||h.createJavaScriptNode,x="。由于"+_+"内部1秒375次回调，在移动端可能会有性能问题导致回调丢失录音变短，PC端无影响，暂不建议开启"+_+"。",w=function(){s=v.isWorklet=!1,A(v),U("Connect采用老的"+S+"，"+(L[R]?"但已":"可")+"设置"+D+"."+R+"=true尝试启用"+_+m+x,3);var e=v._p=M.call(h,p,1,1),t=(g(e),"_D220626"),n=L[t];n&&U("Use "+D+"."+t,3),e.onaudioprocess=function(e){var t=e.inputBuffer.getChannelData(0);n?(t=new Float32Array(t),setTimeout(function(){C(t)})):C(t)}};a=I[k],f="ondataavailable",u="audio/webm; codecs=pcm",i=v.isWebM=L[z],l=a&&f in a.prototype&&a.isTypeSupported(u),m=l?"":"（此浏览器不支持"+e+"）",t&&i&&l?(r=function(){return i&&v._ra},v._ra=function(){""!==c&&(clearTimeout(c),c=setTimeout(function(){r()&&(U(k+"未返回任何音频，降级使用"+_,3),n())},500))},l=Object.assign({mimeType:u},L.ConnectWebMOptions),u=v._r=new a(v,l),o=v._rd={sampleRate:h[F]},u[f]=function(e){var t=new FileReader;t.onloadend=function(){if(r()){var e=P(new Uint8Array(t.result),o);if(!e)return;if(-1==e)return void n();c&&(clearTimeout(c),c=""),C(e)}else i||U(k+"多余回调",3)},t.readAsArrayBuffer(e.data)},u.start(~~(p/48)),U("Connect采用"+e+"，设置"+D+"."+z+"=false可恢复使用"+_+"或老式"+S)):n()}function A(e){e._na=null,e._n&&(e._n.port.postMessage({kill:!0}),e._n.disconnect(),e._n=null)}function T(e){e._ra=null,e._r&&(e._r.stop(),e._r=null)}var C=function(){},D=(L.LM="2023-02-01 18:05","Recorder"),S="getUserMedia",x="srcSampleRate",F="sampleRate",O="catch",n=(L.IsOpen=function(){var e=L.Stream;if(e){var t,e=(e.getTracks&&e.getTracks()||e.audioTracks||[])[0];if(e)return"live"==(t=e.readyState)||t==e.LIVE}return!1},L.BufferSize=4096,L.Destroy=function(){for(var e in U(D+" Destroy"),_(),n)n[e]()},{}),z=(L.BindDestroy=function(e,t){n[e]=t},L.Support=function(){var e=navigator.mediaDevices||{};return e[S]||(e=navigator)[S]||(e[S]=e.webkitGetUserMedia||e.mozGetUserMedia||e.msGetUserMedia),!!e[S]&&(L.Scope=e,!!L.GetContext())},L.GetContext=function(){var e=I.AudioContext;return(e=e||I.webkitAudioContext)?(L.Ctx&&"closed"!=L.Ctx.state||(L.Ctx=new e,L.BindDestroy("Ctx",function(){var e=L.Ctx;e&&e.close&&(e.close(),L.Ctx=0)})),L.Ctx):null},"ConnectEnableWebM"),R=(L[z]=!0,"ConnectEnableWorklet"),_=(L[R]=!1,function(e){var t=(e=e||L)==L,n=e.Stream;if(n&&(n._m&&(n._m.disconnect(),n._m=null),n._p&&(n._p.disconnect(),n._p.onaudioprocess=n._p=null),A(n),T(n),t)){for(var r=n.getTracks&&n.getTracks()||n.audioTracks||[],o=0;o<r.length;o++){var a=r[o];a.stop&&a.stop()}n.stop&&n.stop()}e.Stream=0}),U=(L.SampleData=function(e,t,n,r,o){for(var a=(r=r||{}).index||0,i=r.offset||0,s=r.frameNext||[],r=(o=o||{}).frameSize||1,c=(o.frameType&&(r="mp3"==o.frameType?1152:1),e.length),f=(c+1<a&&U("SampleData似乎传入了未重置chunk "+a+">"+c,3),0),u=a;u<c;u++)f+=e[u].length;for(var f=Math.max(0,f-Math.floor(i)),l=t/n,p=(1<l?f=Math.floor(f/l):(l=1,n=t),f+=s.length,new Int16Array(f)),h=0,u=0;u<s.length;u++)p[h]=s[u],h++;for(;a<c;a++){for(var v=e[a],u=i,g=v.length;u<g;){var m=Math.floor(u),d=Math.ceil(u),C=v[m],d=d<g?v[d]:(e[a+1]||[C])[0]||0;p[h]=C+(d-C)*(u-m),h++,u+=l}i=u-g}s=null;o=p.length%r;return 0<o&&(t=2*(p.length-o),s=new Int16Array(p.buffer.slice(t)),p=new Int16Array(p.buffer.slice(0,t))),{index:a,offset:i,frameNext:s,sampleRate:n,data:p}},L.PowerLevel=function(e,t){e=e/t||0,t=e<1251?Math.round(e/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(e/1e4)/Math.log(10)))));return t},L.PowerDBFS=function(e){e=Math.max(.1,e||0),e=Math.min(e,32767);return e=20*Math.log(e/32767)/Math.log(10),Math.max(-100,Math.round(e))},L.CLog=function(e,t){var n=new Date,n=("0"+n.getMinutes()).substr(-2)+":"+("0"+n.getSeconds()).substr(-2)+"."+("00"+n.getMilliseconds()).substr(-3),r=this&&this.envIn&&this.envCheck&&this.id,o=["["+n+" "+D+(r?":"+r:"")+"]"+e],a=arguments,n=I.console||{},i=2,r=n.log;for("number"==typeof t?r=1==t?n.error:3==t?n.warn:r:i=1;i<a.length;i++)o.push(a[i]);s?r&&r("[IsLoser]"+o[0],1<o.length?o:""):r.apply(n,o)},function(){L.CLog.apply(this,arguments)}),s=!0;try{s=!console.log.apply}catch(e){}var r=0;function t(e){this.id=++r,o();var t,n={type:"mp3",bitRate:16,sampleRate:16e3,onProcess:C};for(t in e)n[t]=e[t];this.set=n,this._S=9,this.Sync={O:9,C:9}}L.Sync={O:9,C:9},L.prototype=t.prototype={CLog:U,_streamStore:function(){return this.set.sourceStream?this:L},open:function(e,n){var r=this,o=r._streamStore(),a=(e=e||C,function(e,t){r.CLog("录音open失败："+e+",isUserNotAllow:"+(t=!!t),1),n&&n(e,t)}),i=function(){r.CLog("open ok id:"+r.id),e(),r._SO=0},t=o.Sync,s=++t.O,c=t.C,f=(r._O=r._O_=s,r._SO=r._S,function(){var e;if(c!=t.C||!r._O)return e="open被取消",s==t.O?r.close():e="open被中断",a(e),!0}),u=r.envCheck({envName:"H5",canProcess:!0});if(u)a("不能录音："+u);else if(r.set.sourceStream)if(L.GetContext()){_(o),r.Stream=r.set.sourceStream,r.Stream._call={};try{d(o)}catch(e){return void a("从流中打开录音失败："+e.message)}i()}else a("不支持此浏览器从流中获取录音");else{var l=function(e,t){try{I.top.a}catch(e){return void a('无权录音(跨域，请尝试给iframe添加麦克风访问策略，如allow="camera;microphone")')}/Permission|Allow/i.test(e)?a("用户拒绝了录音权限",!0):!1===I.isSecureContext?a("浏览器禁止不安全页面录音，可开启https解决"):/Found/i.test(e)?a(t+"，无可用麦克风"):a(t)};if(L.IsOpen())i();else if(L.Support()){var p,u=function(t){setTimeout(function(){t._call={};var e=L.Stream;e&&(_(),t._call=e._call),L.Stream=t,f()||(L.IsOpen()?(e&&r.CLog("发现同时多次调用open",1),d(o,1),i()):a("录音功能无效：无音频流"))},100)},h=function(e){var t=e.name||e.message||e.code+":"+e;r.CLog("请求录音权限错误",1,e),l(t,"无法录音："+t)},v={noiseSuppression:!1,echoCancellation:!1},g=r.set.audioTrackSet;for(p in g)v[p]=g[p];v.sampleRate=L.Ctx.sampleRate;try{var m=L.Scope[S]({audio:v},u,h)}catch(e){r.CLog(S,3,e),m=L.Scope[S]({audio:!0},u,h)}m&&m.then&&m.then(u)[O](h)}else l("","此浏览器不支持录音")}},close:function(e){e=e||C;var t=this,n=t._streamStore(),r=(t._stop(),n.Sync);t._O=0,t._O_!=r.O?t.CLog("close被忽略（因为同时open了多个rec，只有最后一个会真正close）",3):(r.C++,_(n),t.CLog("close")),e()},mock:function(e,t){var n=this;return n._stop(),n.isMock=1,n.mockEnvInfo=null,n.buffers=[e],n.recSize=e.length,n[x]=t,n},envCheck:function(e){var t,n=this.set,r="CPU_BE";return t||L[r]||!I.Int8Array||new Int8Array(new Int32Array([1]).buffer)[0]||(o(r),t="不支持CPU_BE架构"),t||(this[(r=n.type)+"_envCheck"]?t=this[r+"_envCheck"](e,n):n.takeoffEncodeChunk&&(t=r+"类型"+(this[r]?"":"(未加载编码器)")+"不支持设置takeoffEncodeChunk")),t||""},envStart:function(e,t){var n=this,r=n.set,e=(n.isMock=e?1:0,n.mockEnvInfo=e,n.buffers=[],n.recSize=0,n.envInLast=0,n.envInFirst=0,n.envInFix=0,n.envInFixTs=[],r[F]);t<e?r[F]=t:e=0,n[x]=t,n.CLog(x+": "+t+" set."+F+": "+r[F]+(e?" 忽略"+e:""),e?3:0),n.engineCtx=0,n[r.type+"_start"]&&(t=n.engineCtx=n[r.type+"_start"](r))&&(t.pcmDatas=[],t.pcmSize=0)},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){for(var o=this,a=o.set,i=o.engineCtx,n=o[x],r=e.length,t=L.PowerLevel(t,r),s=o.buffers,c=s.length,f=(s.push(e),s),u=c,l=Date.now(),e=Math.round(r/n*1e3),p=(o.envInLast=l,1==o.buffers.length&&(o.envInFirst=l-e),o.envInFixTs),h=(p.splice(0,0,{t:l,d:e}),l),v=0,g=0;g<p.length;g++){var m=p[g];if(3e3<l-m.t){p.length=g;break}h=m.t,v+=m.d}function d(){for(var e=k?0:-_,t=null==s[0],n=c;n<y;n++){var r=s[n];null==r?t=1:(e+=r.length,i&&r.length&&o[a.type+"_encode"](i,r))}if(t&&i){n=u;for(f[0]&&(n=0);n<b;n++)f[n]=null}t&&(e=k?_:0,s[0]=null),i?i.pcmSize+=e:o.recSize+=e}var C=p[1],S=l-h,C=(S/3<S-v&&(C&&1e3<S||6<=p.length)&&e/5<(S=l-C.t-e)&&(C=!a.disableEnvInFix,o.CLog("["+l+"]"+(C?"":"未")+"补偿"+S+"ms",3),o.envInFix+=S,C)&&(r+=(e=new Int16Array(S*n/1e3)).length,s.push(e)),o.recSize),_=r,S=C+_,r=(o.recSize=S,i&&(e=L.SampleData(s,n,a[F],i.chunkInfo),i.chunkInfo=e,S=i.pcmSize+(_=e.data.length),i.pcmSize=S,s=i.pcmDatas,c=s.length,s.push(e.data),n=e[F]),Math.round(S/n*1e3)),y=s.length,b=f.length,k=0,C="rec.set.onProcess";try{k=a.onProcess(s,t,r,n,c,d)}catch(e){console.error(C+"回调出错是不允许的，需保证不会抛异常",e)}e=Date.now()-l;if(10<e&&1e3<o.envInFirst-l&&o.CLog(C+"低性能，耗时"+e+"ms",3),!0===k){for(var M=0,g=c;g<y;g++)null==s[g]?M=1:s[g]=new Int16Array(0);M?o.CLog("未进入异步前不能清除buffers",3):i?i.pcmSize-=_:o.recSize-=_}else d()},start:function(){var t,n,r=this,o=L.Ctx,e=1;r.set.sourceStream?r.Stream||(e=0):L.IsOpen()||(e=0),e?(r.CLog("开始录音"),r._stop(),r.state=3,r.envStart(null,o[F]),r._SO&&r._SO+1!=r._S?r.CLog("start被中断",3):(r._SO=0,t=function(){3==r.state&&(r.state=1,r.resume())},"suspended"==o.state?(r.CLog((n="AudioContext resume: ")+"wait..."),o.resume().then(function(){r.CLog(n+o.state),t()})[O](function(e){r.CLog(n+o.state+" 可能无法录音："+e.message,1,e),t()})):t())):r.CLog("未open",1)},pause:function(){var e=this;e.state&&(e.state=2,e.CLog("pause"),delete e._streamStore().Stream._call[e.id])},resume:function(){var e,n=this;n.state&&(n.state=1,n.CLog("resume"),n.envResume(),(e=n._streamStore().Stream)._call[n.id]=function(e,t){1==n.state&&n.envIn(e,t)},(e=e)._na&&e._na(),e._ra)&&e._ra()},_stop:function(e){var t=this,n=t.set;t.isMock||t._S++,t.state&&(t.pause(),t.state=0),!e&&t[n.type+"_stop"]&&(t[n.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(n,t,e){function r(e,t){if(o.CLog("结束录音 编码花"+(Date.now()-u)+"ms 音频时长"+t+"ms 文件大小"+e.size+"b"),a.takeoffEncodeChunk)o.CLog("启用takeoffEncodeChunk后stop返回的blob长度为0不提供音频数据",3);else if(e.size<Math.max(100,t/2))return f("生成的"+a.type+"无效");n&&n(e,t),c()}var o=this,a=o.set,i=o.envInLast-o.envInFirst,s=i&&o.buffers.length,c=(o.CLog("stop 和start时差"+(i?i+"ms 补偿"+o.envInFix+"ms envIn:"+s+" fps:"+(s/i*1e3).toFixed(1):"-")),function(){o._stop(),e&&o.close()}),f=function(e){o.CLog("结束录音失败："+e,1),t&&t(e),c()};if(!o.isMock){s=3==o.state;if(!o.state||s)return void f("未开始录音"+(s?"，开始录音前无用户交互导致AudioContext未运行":""));o._stop(!0)}i=o.recSize;if(i)if(o.buffers[0])if(o[a.type]){if(o.isMock){s=o.envCheck(o.mockEnvInfo||{envName:"mock",canProcess:!1});if(s)return void f("录音错误："+s)}var u,l,p,s=o.engineCtx;o[a.type+"_complete"]&&s?(p=Math.round(s.pcmSize/a[F]*1e3),u=Date.now(),o[a.type+"_complete"](s,function(e){r(e,p)},f)):(u=Date.now(),s=L.SampleData(o.buffers,o[x],a[F]),a[F]=s[F],l=s.data,p=Math.round(l.length/a[F]*1e3),o.CLog("采样"+i+"->"+l.length+" 花:"+(Date.now()-u)+"ms"),setTimeout(function(){u=Date.now(),o[a.type](l,function(e){r(e,p)},function(e){f(e)})}))}else f("未加载"+a.type+"编码器");else f("音频buffers被释放");else f("未采集到录音")}},I[D]&&(U("重复引入"+D,3),I[D].Destroy());var P=function(e,t){t.pos||(t.pos=[0],t.tracks={},t.bytes=[]);function n(){t.pos[0]=o[0]}var r=t.tracks,o=[t.pos[0]],a=t.bytes.length,i=new Uint8Array(a+e.length);if(i.set(t.bytes),i.set(e,a),t.bytes=i,!t._ht){if(B(i,o),N(i,o),!W(B(i,o),[24,83,128,103]))return;for(B(i,o);o[0]<i.length;){var s=B(i,o),c=N(i,o),f=[0],u=0;if(!c)return;if(W(s,[22,84,174,107])){for(;f[0]<c.length;){var l=B(c,f),p=N(c,f),h=[0],v={channels:0,sampleRate:0};if(W(l,[174]))for(;h[0]<p.length;){var g=B(p,h),m=N(p,h),d=[0];if(W(g,[215])){var C=E(m);r[v.number=C]=v}else if(W(g,[131]))1==(C=E(m))?v.type="video":2==C?(v.type="audio",u||(t.track0=v),v.idx=u++):v.type="Type-"+C;else if(W(g,[134])){for(var S="",_=0;_<m.length;_++)S+=String.fromCharCode(m[_]);v.codec=S}else if(W(g,[225]))for(;d[0]<m.length;){var y=B(m,d),b=N(m,d);W(y,[181])?(C=0,A=new Uint8Array(b.reverse()).buffer,4==b.length?C=new Float32Array(A)[0]:8==b.length?C=new Float64Array(A)[0]:U("WebM Track !Float",1,b),v[F]=Math.round(C)):W(y,[98,100])?v.bitDepth=E(b):W(y,[159])&&(v.channels=E(b))}}}t._ht=1,U("WebM Tracks",r),n();break}}}var k=t.track0;if(k){if(16==k.bitDepth&&/FLOAT/i.test(k.codec)&&(k.bitDepth=32,U("WebM 16改32位",3)),k[F]!=t[F]||32!=k.bitDepth||k.channels<1||!/(\b|_)PCM\b/i.test(k.codec))return t.bytes=[],t.bad||U("WebM Track非预期",3,t),-(t.bad=1);for(var M=[],x=0;o[0]<i.length;){l=B(i,o);if(!(p=N(i,o)))break;if(W(l,[163])){var w=15&p[0];if(v=r[w]){if(0===v.idx){for(var I=new Uint8Array(p.length-4),_=4;_<p.length;_++)I[_-4]=p[_];M.push(I),x+=I.length}}else U("WebM !Track"+w,1,r)}n()}if(x){for(var e=new Uint8Array(i.length-t.pos[0]),I=(e.set(i.subarray(t.pos[0])),t.bytes=e,t.pos[0]=0,new Uint8Array(x)),_=0,L=0;_<M.length;_++)I.set(M[_],L),L+=M[_].length;var A=new Float32Array(I.buffer);if(1<k.channels){for(var T=[],_=0;_<A.length;)T.push(A[_]),_+=k.channels;A=new Float32Array(T)}return A}}},W=function(e,t){if(!e||e.length!=t.length)return!1;if(1==e.length)return e[0]==t[0];for(var n=0;n<e.length;n++)if(e[n]!=t[n])return!1;return!0},E=function(e){for(var t="",n=0;n<e.length;n++){var r=e[n];t+=(r<16?"0":"")+r.toString(16)}return parseInt(t,16)||0},B=function(e,t,n){var r=t[0];if(!(r>=e.length)){var o=("0000000"+e[r].toString(2)).substr(-8),o=/^(0*1)(\d*)$/.exec(o);if(o){var a=o[1].length,i=[];if(!(r+a>e.length)){for(var s=0;s<a;s++)i[s]=e[r],r++;return n&&(i[0]=parseInt(o[2]||"0",2)),t[0]=r,i}}}},N=function(e,t){var n=B(e,t,1);if(n){var r=E(n),o=t[0],a=[];if(r<2147483647){if(o+r>e.length)return;for(var i=0;i<r;i++)a[i]=e[o],o++}return t[0]=o,a}},o=((I[D]=L).TrafficImgUrl="//ia.51.la/go1?id=20469973&pvFlag=1",L.Traffic=function(e){e=e?"/"+D+"/Report/"+e:"";var t,n,r,o=L.TrafficImgUrl;o&&(t=L.Traffic,n=(r=/^(https?:..[^\/#]*\/?)[^#]*/i.exec(location.href)||[])[1]||"http://file/",r=(r[0]||n)+e,0==o.indexOf("//")&&(o=/^https:/i.test(r)?"https:"+o:"http:"+o),e&&(o=o+"&cu="+encodeURIComponent(n+e)),t[r]||(t[r]=1,(new Image).src=o,U("Traffic Analysis Image: "+(e||D+".TrafficImgUrl="+L.TrafficImgUrl))))});"function"==typeof define&&define.amd&&define(function(){return Recorder}),"object"==typeof module&&module.exports&&(module.exports=Recorder)})();