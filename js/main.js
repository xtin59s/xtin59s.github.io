var audioBlob,file_data_array,wsconnecter=new WebSocketConnectMethod({msgHandle:getJsonMessage,stateHandle:getConnState}),rec=Recorder({type:"pcm",bitRate:16,sampleRate:16e3,onProcess:recProcess}),sampleBuf=new Int16Array,btnStart=document.getElementById("btnStart"),btnStop=(btnStart.onclick=record,document.getElementById("btnStop")),awsslink=(btnStop.onclick=stop,btnStart.disabled=btnStop.disabled=!0,(btnConnect=document.getElementById("btnConnect")).onclick=start,document.getElementById("wsslink")),rec_text="",offline_text="",info_div=document.getElementById("info_div"),upfile=document.getElementById("upfile"),isfilemode=!1,file_ext="",file_sample_rate=16e3,totalsend=0,now_ipaddress=window.location.href,localport=(now_ipaddress=(now_ipaddress=now_ipaddress.replace("https://","wss://")).replace("static/index.html",""),window.location.port);function addresschange(){var e=document.getElementById("wssip").value;document.getElementById("info_wslink").innerHTML="点此处手工授权（IOS手机）",e=e.replace(/wss/g,"https"),console.log("addresschange uri=",e),awsslink.onclick=function(){window.open(e,"_blank")}}now_ipaddress=now_ipaddress.replace(localport,"10095"),document.getElementById("wssip").value=now_ipaddress,addresschange(),upfile.onclick=function(){btnStart.disabled=!0,btnStop.disabled=!0,btnConnect.disabled=!1};var readWavInfo=function(e){if(!(e.byteLength<44)){var o=e,e=function(e,t){for(var n=0;n<t.length;n++)if(o[e+n]!=t.charCodeAt(n))return!1;return!0};if(e(0,"RIFF")&&e(8,"WAVEfmt ")){e=o[22];if(1==o[20]&&(1==e||2==e)){for(var t=o[24]+(o[25]<<8)+(o[26]<<16)+(o[27]<<24),n=o[34]+(o[35]<<8),l=[o.subarray(0,12)],a=12,s=0,i=12,r=o.length-8;i<r;){if(100==o[i]&&97==o[i+1]&&116==o[i+2]&&97==o[i+3]){l.push(o.subarray(i,i+8)),a+=8,s=i+8;break}var d=i;i=(i+=4)+(4+o[i]+(o[i+1]<<8)+(o[i+2]<<16)+(o[i+3]<<24)),12==d&&(l.push(o.subarray(d,i)),a+=i-d)}if(s){for(var c=new Uint8Array(a),i=0,f=0;i<l.length;i++)c.set(l[i],f),f+=l[i].length;return{sampleRate:t,bitRate:n,numChannels:e,wavHead44:c,dataPos:s}}}}}return null};function play_file(){var e=new Blob([new Uint8Array(file_data_array)],{type:"audio/wav"}),t=document.getElementById("audio_record");t.src=(window.URL||webkitURL).createObjectURL(e),t.controls=!0}function start_file_send(){sampleBuf=new Uint8Array(file_data_array);for(;960<=sampleBuf.length;)sendBuf=sampleBuf.slice(0,960),totalsend+=sampleBuf.length,sampleBuf=sampleBuf.slice(960,sampleBuf.length),wsconnecter.wsSend(sendBuf);stop()}function on_recoder_mode_change(){for(var e=null,t=document.getElementsByName("recoder_mode"),n=0;n<t.length;n++)if(t[n].checked){e=t[n].value;break}"mic"==e?(document.getElementById("mic_mode_div").style.display="block",document.getElementById("rec_mode_div").style.display="none",btnStart.disabled=!0,btnStop.disabled=!0,btnConnect.disabled=!1,isfilemode=!1):(document.getElementById("mic_mode_div").style.display="none",document.getElementById("rec_mode_div").style.display="block",btnStart.disabled=!0,btnStop.disabled=!0,btnConnect.disabled=!0,isfilemode=!0,info_div.innerHTML="请点击选择文件")}function getHotwords(){var e=document.getElementById("varHot");if(void 0===e||null==e||e.value.length<=0)return null;var e=e.value.toString(),e=(console.log("hotwords="+e),e.split(/[(\r\n)\r\n]+/)),t={},n=/^[0-9]*$/;for(item of e){var o=item.split(" ");if(2<=o.length&&n.test(o[o.length-1])){for(var l="",a=0;a<o.length-1;a++)l=l+o[a]+" ";t[l.trim()]=parseInt(o[o.length-1])}}return console.log("jsonresult="+JSON.stringify(t)),JSON.stringify(t)}function getAsrMode(){for(var e=null,t=document.getElementsByName("asr_mode"),n=0;n<t.length;n++)if(t[n].checked){e=t[n].value;break}return isfilemode&&(e="offline"),console.log("asr mode"+e),e}function handleWithTimestamp(e,t){if(console.log("tmptext: "+e),console.log("tmptime: "+t),null==t||"undefined"==t||e.length<=0)return e;for(var n=(e=e.replace(/。|？|，|、|\?|\.|\ /g,",")).split(","),o=JSON.parse(t),l=0,a="",s=0;s<n.length;s++)"undefined"==n[s]||n[s].length<=0||(console.log("words===",n[s]),console.log("words: "+n[s]+",time="+o[l][0]/1e3),/^[a-zA-Z]+$/.test(n[s])?(a=a+o[l][0]/1e3+":"+n[s]+"\n",l+=1):(a=a+o[l][0]/1e3+":"+n[s]+"\n",l+=n[s].length));return a}function getJsonMessage(e){console.log("message: "+JSON.parse(e.data).text);var t=""+JSON.parse(e.data).text,n=JSON.parse(e.data).mode,o=JSON.parse(e.data).is_final,e=JSON.parse(e.data).timestamp;"2pass-offline"==n||"offline"==n?(offline_text+=handleWithTimestamp(t,e),rec_text=offline_text):rec_text+=t,document.getElementById("varArea").value=rec_text,console.log("offline_text: "+n+","+offline_text),console.log("rec_text: "+rec_text),1==isfilemode&&1==o&&(console.log("call stop ws!"),play_file(),wsconnecter.wsStop(),info_div.innerHTML="请点击连接",btnStart.disabled=!0,btnStop.disabled=!0,btnConnect.disabled=!1)}function getConnState(e){0===e?(info_div.innerHTML="连接成功!请点击开始",1==isfilemode?(info_div.innerHTML="请耐心等待,大文件等待时间更长",start_file_send()):(btnStart.disabled=!1,btnStop.disabled=!0,btnConnect.disabled=!0)):1!==e&&2===e&&(stop(),console.log("connecttion error"),alert("连接地址"+document.getElementById("wssip").value+"失败,请检查asr地址和端口。或试试界面上手动授权，再连接。"),btnStart.disabled=!0,btnStop.disabled=!0,btnConnect.disabled=!1,info_div.innerHTML="请点击连接")}function record(){rec.open(function(){rec.start(),console.log("开始"),btnStart.disabled=!0,btnStop.disabled=!1,btnConnect.disabled=!0})}function start(){return clear(),console.log("isfilemode"+isfilemode),1==wsconnecter.wsStart()?(info_div.innerHTML="正在连接asr服务器，请等待...",isRec=!0,btnStart.disabled=!0,btnStop.disabled=!0,btnConnect.disabled=!0,1):(info_div.innerHTML="请点击开始",btnStart.disabled=!0,btnStop.disabled=!0,btnConnect.disabled=!1,0)}function stop(){var e={chunk_size:new Array(5,10,5),wav_name:"h5",is_speaking:!1,chunk_interval:10,mode:getAsrMode()};console.log(e),0<sampleBuf.length&&(wsconnecter.wsSend(sampleBuf),console.log("sampleBuf.length"+sampleBuf.length),sampleBuf=new Int16Array),wsconnecter.wsSend(JSON.stringify(e)),isRec=!1,info_div.innerHTML="发送完数据,请等候,正在识别...",0==isfilemode&&(btnStop.disabled=!0,btnStart.disabled=!0,btnConnect.disabled=!0,setTimeout(function(){console.log("call stop ws!"),wsconnecter.wsStop(),btnConnect.disabled=!1,info_div.innerHTML="请点击连接"},3e3),rec.stop(function(e,t){console.log(e);Recorder.pcm2wav(data={sampleRate:16e3,bitRate:16,blob:e},function(e,t){console.log(e);var n=document.getElementById("audio_record");n.src=(window.URL||webkitURL).createObjectURL(e),n.controls=!0},function(e){console.log(e)})},function(e){console.log("errMsg: "+e)}))}function clear(){document.getElementById("varArea").value="",offline_text=rec_text=""}function recProcess(e,t,n,o,l,a){if(!0===isRec){e=e[e.length-1],e=new Array(e),e=Recorder.SampleData(e,o,16e3).data;sampleBuf=Int16Array.from([...sampleBuf,...e]);for(info_div.innerHTML=n/1e3+"s";960<=sampleBuf.length;)sendBuf=sampleBuf.slice(0,960),sampleBuf=sampleBuf.slice(960,sampleBuf.length),wsconnecter.wsSend(sendBuf)}}function getUseITN(){for(var e=document.getElementsByName("use_itn"),t=0;t<e.length;t++)if(e[t].checked)return"true"===e[t].value;return!1}upfile.onchange=function(){var n,o=this.files.length;for(let t=0;t<o;t++){let e=new FileReader;e.readAsArrayBuffer(this.files[t]),file_ext=this.files[t].name.split(".").pop().toLowerCase(),e.onload=function(){n=e.result,file_data_array=n,info_div.innerHTML="请点击连接进行识别"},e.onerror=function(e){console.log("error"+e)}}if("wav"==file_ext)for(let e=0;e<o;e++){let t=new FileReader;t.readAsArrayBuffer(this.files[e]),t.onload=function(){n=new Uint8Array(t.result);var e=readWavInfo(n);console.log(e),file_sample_rate=e.sampleRate}}};